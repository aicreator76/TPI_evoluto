name: CI
on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  statuses: write

jobs:
  sanity:
    name: Sanity
    runs-on: ubuntu-latest
    steps:
      - run: echo "CI sanity OK"

  lint-type:
    name: Lint & Typecheck (stub)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python --version

  tests:
    name: Tests (stub)
    runs-on: ubuntu-latest
    needs: lint-type
    steps:
      - run: echo "no tests yet"

  ci-status-bridge:
    name: CI status bridge
    runs-on: ubuntu-latest
    needs: [lint-type, tests]
    if: always()
    permissions:
      statuses: write
    steps:
      - name: Publish required commit status CI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          state="success"
          if [ "${{ needs.lint-type.result }}" = "failure" ] || [ "${{ needs.tests.result }}" = "failure" ]; then state="failure"; fi
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d @- <<JSON
          {"state":"$state","context":"CI","description":"Bridge status for branch protection","target_url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}
          JSON
